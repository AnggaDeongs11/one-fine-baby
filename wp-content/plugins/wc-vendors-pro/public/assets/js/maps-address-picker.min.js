var placeSearch,autocomplete,componentForm={locality:"long_name",administrative_area_level_1:"short_name",country:"long_name",postal_code:"short_name"},address_fields={_wcv_store_city:"long_name",_wcv_store_state:"short_name",_wcv_store_country:"long_name",_wcv_store_postcode:"short_name"},map_address_fields={locality:"_wcv_store_city",administrative_area_level_1:"_wcv_store_state",country:"_wcv_store_country",postal_code:"_wcv_store_postcode"},initializeMap=function(){if(google&&"undefined"!=typeof google){autocomplete=new google.maps.places.Autocomplete(document.getElementById("_wcv_store_search_address"),{types:["geocode"]});var e=new google.maps.Map(document.getElementById("wcv_location_picker"),{zoom:parseInt(wcv_frontend_general.map_zoom_level),center:{lat:getFormLatitude(),lng:getFormLongitude()}}),o=new google.maps.Geocoder,t=new google.maps.Marker({map:e,position:new google.maps.LatLng(getFormLatitude(),getFormLongitude()),draggable:!0,animation:google.maps.Animation.DROP});initilizeGeoCoder(o,t,e),wcvGeoCode({geocoder:o,marker:t,map:e,what:"address"}),autocomplete.addListener("place_changed",function(){fillInAddress(null),wcvGeoCode({geocoder:o,marker:t,map:e,what:"address"})})}else $("#wcv_location_picker").hide()},fillInAddress=function(e){var o=null!=e&&null!=e?e:autocomplete.getPlace();if(null!=o&&null!=o){$("#_wcv_store_city").val(""),$("#_wcv_store_state").val(""),$("#_wcv_store_country").val(""),$("#_wcv_store_postcode").val("");for(var t=o.formatted_address,a=0;a<o.address_components.length;a++){var n=o.address_components[a].types[0];if(map_address_fields[n]){var r=o.address_components[a][componentForm[n]];if("country"==n){var s=o.address_components[a].short_name;$("#_wcv_store_country").val(s).trigger("change")}else document.getElementById(map_address_fields[n]).value=r;"country"!==n&&"administrative_area_level_1"!==n&&"locality"!==n&&"postal_code"!==n||(t=(t=t.replace(o.address_components[a].long_name,"")).replace(o.address_components[a].short_name,""))}}t=(t=(t=t.replace(/,\s+,/,"")).replace(/,\s*$/,"")).trim(),$("#_wcv_store_search_address").val(o.formatted_address),$("#_wcv_store_address1").val(t),setLatitudeLongitude(o.geometry.location.lat(),o.geometry.location.lng())}},initilizeGeoCoder=function(t,a,n){var e=$("#_wcv_store_search_address").val();t.geocode({address:e},function(e,o){"OK"===o?(n.setCenter(e[0].geometry.location),n.setCenter({lat:parseFloat(e[0].geometry.location.lat()),lng:parseFloat(e[0].geometry.location.lng())}),google.maps.event.addListener(a,"dragend",function(e){wcvGeoCode({geocoder:t,marker:a,map:n,what:"latlng",position:e.latLng}),n.panTo(e.latLng)}),n.addListener("click",function(e){wcvGeoCode({geocoder:t,marker:a,map:n,what:"latlng",position:e.latLng}),n.panTo(e.latLng)})):console.log("Geocode was not successful for the following reason: "+o)})};wcvGeoCode=function(t){var e;if("address"==t.what)e={address:document.getElementById("_wcv_store_search_address").value};else if("latlng"==t.what){e={location:{lat:parseFloat(t.position.lat()),lng:parseFloat(t.position.lng())}}}null!=e&&t.geocoder.geocode(e,function(e,o){o==google.maps.GeocoderStatus.OK?("address"==t.what&&$("#_wcv_store_search_address").val(e[0].formatted_address),t.map.setCenter({lat:parseFloat(e[0].geometry.location.lat()),lng:parseFloat(e[0].geometry.location.lng())}),t.marker.setPosition({lat:parseFloat(e[0].geometry.location.lat()),lng:parseFloat(e[0].geometry.location.lng())}),fillInAddress(e[0]),t.map.panTo(e[0].geometry.location)):console.log(wcv_frontend_general.cannot_find_address_text+" "+o)})};var setLatitudeLongitude=function(e,o){$("#wcv_address_latitude").val(e),$("#wcv_address_longitude").val(o)},getFormLatitude=function(){return""!=$("#wcv_address_latidude").val()&&null!=$("#wcv_address_latidude").val()?parseFloat($("#wcv_address_latitude").val()):-34.397},getFormLongitude=function(){return""!=$("#wcv_address_longitude").val()&&null!=$("#wcv_address_longitude").val()?parseFloat($("#wcv_address_longitude").val()):29.644},geoLocatePosition=function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var o=e.coords.latitude,t=e.coords.longitude,a=new google.maps.LatLng(o,t);(new google.maps.Geocoder).geocode({latLng:a},function(e,o){o===google.maps.GeocoderStatus.OK&&e[0]&&$("#_wcv_store_search_address").val(e[0].formatted_address).trigger("change")})})},showHideMapText=function(){$("#wcv_location_picker").is(":visible")?$("#show_location_picker").text(wcv_frontend_general.hide_location_picker_text):$("#show_location_picker").text(wcv_frontend_general.use_location_picker_text)},get_current_address=function(){var e=$("#_wcv_store_address1").val(),o=$("#_wcv_store_state").val(),t=$("#_wcv_store_country").val(),a=e+" "+o+" "+$("#_wcv_store_postcode").val()+" "+t;return a=(a=a.replace(/ +(?= )/g,"")).trim()};$(document).ready(function(){var e=get_current_address(),o=$("#_wcv_store_search_address");o.on("change",function(){initializeMap()}),$("#show_location_picker").click(function(e){e.preventDefault(),$("#wcv_location_picker").toggle(),showHideMapText()}),$("#use_current_position").click(function(e){e.preventDefault(),geoLocatePosition()}),0<e.length?o.val(e).trigger("change"):geoLocatePosition()});